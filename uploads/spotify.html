<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Spotify Playlist to CSV</title>
</head>
<body>
    <h2>Step 1: Choose Playlist</h2>
    <select id="playlistSelect">
        <option value="" disabled selected>Select Playlist</option>
    </select>
    <button id="loadPlaylistsBtn">Load Playlists</button>
    
    <h2>Step 2: Export Playlist</h2>
    <button id="exportBtn">Export Selected Playlist</button>

    <script>
        // *********** CONFIG ***********
        const clientId = 'd9391fc2d7b846eabdf949ccf48e2207';
        const redirectUri = window.location.origin + window.location.pathname; // must match dashboard
        const scopes = 'playlist-read-private playlist-read-collaborative';

        // *********** PKCE HELPERS ***********
        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return new Uint8Array(digest);
        }

        function base64UrlEncode(bytes) {
            let binary = '';
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        async function generateCodeChallenge(codeVerifier) {
            const hashed = await sha256(codeVerifier);
            return base64UrlEncode(hashed);
        }

        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let text = '';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        // *********** AUTH FLOW ***********
        function getStoredToken() {
            const token = sessionStorage.getItem('spotify_access_token');
            const expiry = sessionStorage.getItem('spotify_token_expiry');
            if (!token || !expiry) return null;
            if (Date.now() > parseInt(expiry, 10)) {
                sessionStorage.removeItem('spotify_access_token');
                sessionStorage.removeItem('spotify_token_expiry');
                return null;
            }
            return token;
        }

        function storeToken(accessToken, expiresIn) {
            const expiryTime = Date.now() + expiresIn * 1000;
            sessionStorage.setItem('spotify_access_token', accessToken);
            sessionStorage.setItem('spotify_token_expiry', expiryTime.toString());
        }

        async function redirectToAuthorization() {
            const codeVerifier = generateRandomString(64);
            sessionStorage.setItem('spotify_code_verifier', codeVerifier);

            const codeChallenge = await generateCodeChallenge(codeVerifier);

            const authUrl = new URL('https://accounts.spotify.com/authorize');
            authUrl.searchParams.set('client_id', clientId);
            authUrl.searchParams.set('response_type', 'code');
            authUrl.searchParams.set('redirect_uri', redirectUri);
            authUrl.searchParams.set('scope', scopes);
            authUrl.searchParams.set('code_challenge_method', 'S256');
            authUrl.searchParams.set('code_challenge', codeChallenge);

            window.location.href = authUrl.toString();
        }

        async function handleRedirectCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');

            if (error) {
                console.error('Spotify auth error:', error);
                return;
            }

            if (!code) return;

            const codeVerifier = sessionStorage.getItem('spotify_code_verifier');
            if (!codeVerifier) {
                console.error('Missing code verifier.');
                return;
            }

            // Exchange code for token via PKCE (no client secret)
            const body = new URLSearchParams();
            body.set('client_id', clientId);
            body.set('grant_type', 'authorization_code');
            body.set('code', code);
            body.set('redirect_uri', redirectUri);
            body.set('code_verifier', codeVerifier);

            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: body.toString()
            });

            if (!response.ok) {
                console.error('Token exchange failed', await response.text());
                return;
            }

            const data = await response.json();
            storeToken(data.access_token, data.expires_in);

            // Clean URL (remove ?code=...)
            window.history.replaceState({}, document.title, redirectUri);
        }

        // *********** SPOTIFY API ***********
        function fetchPlaylists(token) {
            return fetch('https://api.spotify.com/v1/me/playlists?limit=50', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch user playlists');
                }
                return response.json();
            })
            .then(data => data.items);
        }

        async function fetchAllPlaylistTracks(token, playlistId) {
            let offset = 0;
            let allTracks = [];
            const limit = 100;
            let totalTracks = limit;
            while (offset < totalTracks) {
                const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks?offset=${offset}&limit=${limit}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch playlist tracks');
                }
                const data = await response.json();
                allTracks = allTracks.concat(data.items);
                totalTracks = data.total;
                offset += limit;
            }
            return allTracks;
        }

        // *********** CSV HELPERS ***********
        function escapeCSV(value) {
            if (value == null) return '""';
            const str = String(value);
            return `"${str.replace(/"/g, '""')}"`;
        }

        function convertJSONToCSV(data) {
            if (!data.length) return '';
            const headers = Object.keys(data[0]).join(',');
            const rows = data.map(obj => Object.values(obj).map(escapeCSV).join(','));
            return `${headers}\n${rows.join('\n')}`;
        }

        // *********** UI ACTIONS ***********
        async function populateDropdown() {
            let accessToken = getStoredToken();
            if (!accessToken) {
                await redirectToAuthorization();
                return;
            }

            try {
                const playlists = await fetchPlaylists(accessToken);
                const dropdown = document.getElementById('playlistSelect');
                dropdown.innerHTML = '<option value="" disabled selected>Select Playlist</option>';
                playlists.forEach(playlist => {
                    const option = document.createElement('option');
                    option.value = playlist.id;
                    option.text = playlist.name;
                    dropdown.appendChild(option);
                });
            } catch (err) {
                console.error(err);
                alert('Failed to load playlists. You may need to log in again.');
                sessionStorage.removeItem('spotify_access_token');
                sessionStorage.removeItem('spotify_token_expiry');
            }
        }

        async function exportPlaylistToCSV() {
            const playlistId = document.getElementById('playlistSelect').value;
            if (!playlistId) {
                alert('Please select a playlist');
                return;
            }

            let accessToken = getStoredToken();
            if (!accessToken) {
                await redirectToAuthorization();
                return;
            }

            try {
                const tracks = await fetchAllPlaylistTracks(accessToken, playlistId);
                const formattedTracks = tracks
                    .filter(item => item && item.track)
                    .map(item => ({
                        'Artist Name(s)': item.track.artists.map(artist => artist.name).join('; '),
                        'Track Name': item.track.name,
                        'Album Name': item.track.album.name
                    }));
                const csvData = convertJSONToCSV(formattedTracks);
                const blob = new Blob([csvData], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'playlist.csv';
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } catch (err) {
                console.error(err);
                alert('Failed to export playlist. You may need to log in again.');
            }
        }

        // *********** INIT ***********
        (async () => {
            await handleRedirectCallback();

            document.getElementById('loadPlaylistsBtn').addEventListener('click', populateDropdown);
            document.getElementById('exportBtn').addEventListener('click', exportPlaylistToCSV);
        })();
    </script>
</body>
</html>
